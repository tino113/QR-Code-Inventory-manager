{% extends 'base.html' %}
{% block content %}
<h2>Scanner</h2>
<div class="mb-3">
  <label>Pair window (seconds): <span id="window-label">10</span></label>
  <input type="range" id="window" class="form-range" min="1" max="60" value="10">
</div>
<p>Please allow camera access when prompted.</p>
<select id="camera-select" class="form-select mb-3"></select>
<div id="reader" style="width:100%;max-width:400px;"></div>
<div id="scan-message" class="mt-3"></div>
<ul id="scan-log" class="list-group mt-3"></ul>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" integrity="sha512-zEPNRM+cO3HcCm4l+zvNAhSWZ02sY1pbgr4o78rksSA3w8EMXRlm6bkQoAjMYu9c1tbk1IMwklD1du4ylXmqWA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
const windowSlider = document.getElementById('window');
const windowLabel = document.getElementById('window-label');
windowSlider.oninput = () => windowLabel.textContent = windowSlider.value;
const html5QrCode = new Html5Qrcode('reader');
const logList = document.getElementById('scan-log');
const cameraSelect = document.getElementById('camera-select');

// keep a simple array in case we want to inspect the log programmatically
const scanLog = [];

function addLog(text) {
  const time = new Date().toLocaleTimeString();
  scanLog.push({ time, text });
  logList.insertAdjacentHTML('afterbegin', `<li class="list-group-item">${time} - ${text}</li>`);
}

function beep(){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  osc.frequency.value = 440;
  osc.connect(ctx.destination);
  osc.start();
  setTimeout(()=>osc.stop(),150);
}

function start(camera){
  html5QrCode.start(camera, {fps:10, qrbox:250}, onScanSuccess)
    .catch(err => { console.error(err); });
}

async function initCameras(){
  const msg = document.getElementById('scan-message');
  if(!window.isSecureContext && location.hostname !== 'localhost'){
    msg.textContent = 'Camera access requires HTTPS or localhost.';
    return;
  }
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    msg.textContent = 'Camera API not available.';
    return;
  }
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
    stream.getTracks().forEach(t => t.stop());
    try{
      const cameras = await Html5Qrcode.getCameras();
      if(cameras.length){
        cameras.forEach((cam, idx) => {
          const opt = document.createElement('option');
          opt.value = cam.id;
          opt.text = cam.label || `Camera ${idx+1}`;
          cameraSelect.appendChild(opt);
        });
        if(cameras.length <= 1){
          cameraSelect.style.display = 'none';
        }
        let preferred = cameras.find(c => /back|rear|environment/i.test(c.label)) || cameras[0];
        cameraSelect.value = preferred.id;
        start(preferred.id);
      }else{
        cameraSelect.style.display = 'none';
        start({facingMode:{exact:'environment'}});
      }
    }catch(e){
      cameraSelect.style.display = 'none';
      start({facingMode:{exact:'environment'}});
    }
  }catch(err){
    console.error('Camera initialization failed', err);
    msg.textContent = 'Unable to access camera.';
  }
}

cameraSelect.addEventListener('change', () => {
  html5QrCode.stop().then(()=> start(cameraSelect.value));
});

// debounce only repeats of the same code within one second
let lastScan = { code: null, time: 0 };
let last = null;

function onScanSuccess(decodedText){
  const now = Date.now();
  if(lastScan.code === decodedText && (now - lastScan.time) < 1000){
    return; // ignore rapid repeat of the same code
  }
  lastScan = { code: decodedText, time: now };

  beep();

  fetch(`/scan/${decodedText}?ajax=1&window=${windowSlider.value}`)
    .then(r=>r.json()).then(data=>{
      const msg = document.getElementById('scan-message');
      const nameHtml = data.name ? ` - <b>${data.name}</b>` : '';
      addLog(`Scanned ${decodedText}${nameHtml}`);
      if(data.message){
        msg.innerHTML = data.message;
        addLog(data.message);
        last = null;
      }else if(data.pending){
        msg.textContent = 'First code scanned...';
        last = {type:data.type, code:data.code};
        setTimeout(()=>{
          if(last && last.code === data.code){
            window.location = `/${data.type}/${data.code}`;
          }
        }, windowSlider.value * 1000);
      }else if(data.error){
        msg.textContent = data.error;
      }
    });
}

initCameras();
</script>
{% endblock %}

