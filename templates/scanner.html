{% extends 'base.html' %}
{% block content %}
<h2>Scanner</h2>
<div class="mb-3">
  <label>Pair window (seconds): <span id="window-label">5</span></label>
  <input type="range" id="window" class="form-range" min="1" max="60" value="5">
</div>
<p>Please allow camera access when prompted.</p>
<button id="start-btn" class="btn btn-primary btn-lg w-100 mb-3">Start Camera</button>
<button id="done-btn" class="btn btn-secondary btn-lg w-100 mb-3" style="display:none;">Done</button>
<select id="camera-select" class="form-select mb-3" style="display:none;"></select>
<video id="video" style="width:100%;max-width:400px;" autoplay muted playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>
<div id="scan-message" class="mt-3"></div>
<ul id="scan-log" class="list-group mt-3"></ul>
<script src="{{ url_for('static', filename='js/jsqr.js') }}"></script>
<script>
const windowSlider = document.getElementById('window');
const windowLabel = document.getElementById('window-label');
windowSlider.oninput = () => windowLabel.textContent = windowSlider.value;
const logList = document.getElementById('scan-log');
const cameraSelect = document.getElementById('camera-select');
const startBtn = document.getElementById('start-btn');
const doneBtn = document.getElementById('done-btn');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// keep a simple array in case we want to inspect the log programmatically
const scanLog = [];

function addLog(text) {
  const time = new Date().toLocaleTimeString();
  const li = document.createElement('li');
  li.className = 'list-group-item';
  li.innerHTML = `${time} - ${text}`;
  logList.insertAdjacentElement('afterbegin', li);
  scanLog.push({ time, text });
  return li;
}

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq = 440){
  const osc = audioCtx.createOscillator();
  osc.frequency.value = freq;
  osc.connect(audioCtx.destination);
  osc.start();
  setTimeout(()=>{
    osc.stop();
    osc.disconnect();
  },150);
}

let stream = null;

async function startStream(deviceId){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
  const constraints = {
    video: deviceId ? {deviceId:{exact:deviceId}} : {facingMode:{ideal:'environment'}},
    audio:false
  };
  stream = await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject = stream;
  await video.play();
  requestAnimationFrame(tick);
}

async function initCameras(){
  startBtn.style.display = 'none';
  doneBtn.style.display = 'block';
  const msg = document.getElementById('scan-message');
  if(!window.isSecureContext && location.hostname !== 'localhost'){
    msg.textContent = 'Camera access requires HTTPS or localhost.';
    return;
  }
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    msg.textContent = 'Camera API not available.';
    return;
  }
  try{
    const temp = await navigator.mediaDevices.getUserMedia({video:true});
    temp.getTracks().forEach(t=>t.stop());
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d=>d.kind === 'videoinput');
    cameraSelect.innerHTML = '';
    cams.forEach((cam, idx)=>{
      const opt = document.createElement('option');
      opt.value = cam.deviceId;
      opt.text = cam.label || `Camera ${idx+1}`;
      cameraSelect.appendChild(opt);
    });
    cameraSelect.style.display = cams.length > 1 ? 'block' : 'none';
    const preferred = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0];
    cameraSelect.value = preferred.deviceId;
    await startStream(preferred.deviceId);
  }catch(err){
    console.error('Camera initialization failed', err);
    msg.textContent = 'Unable to access camera.';
  }
}

cameraSelect.addEventListener('change', () => {
  startStream(cameraSelect.value);
});

// debounce only repeats of the same code within a short interval
const pollInterval = 600; // ms
const recentScans = new Map();
let last = null;
let processing = false;
const queue = [];
let pendingTimeout = null;

function processNext(){
  if(queue.length === 0){
    processing = false;
    return;
  }
  const decodedText = queue.shift();
  const entry = addLog(`Scanned ${decodedText}`);
  beep();
  fetch(`/scan/${decodedText}?ajax=1&window=${windowSlider.value}`)
    .then(r=>r.json())
    .then(data=>{
      const msg = document.getElementById('scan-message');
      if(data.name){
        entry.innerHTML += ` - <b>${data.name}</b>`;
      }
      if(data.message){
        msg.innerHTML = data.message;
        msg.classList.remove('text-danger');
        // registration tone
        beep(660);
        addLog(data.message);
        last = null;
        if(pendingTimeout){
          clearTimeout(pendingTimeout);
          pendingTimeout = null;
        }
      }else if(data.pending){
        msg.classList.remove('text-danger');
        msg.textContent = 'First code scanned...';
        last = {type:data.type, code:data.code};
        if(pendingTimeout){
          clearTimeout(pendingTimeout);
        }
        pendingTimeout = setTimeout(()=>{
          if(last && last.code === data.code){
            window.location = `/${data.type}/${data.code}`;
          }
        }, windowSlider.value * 1000);
      }else if(data.error){
        const prefix = decodedText.split('-')[0];
        const typeMap = { 'IT':'item', 'CT':'container', 'LC':'location' };
        let t = typeMap[prefix];
        if(t){
          window.location = `/add/${t}?code=${decodedText}`;
        }else{
          const msgDiv = document.getElementById('scan-message');
          msgDiv.innerHTML = `Unknown code. Add as:<div class="mt-2">`
            + `<button class=\"btn btn-sm btn-primary me-2\" onclick=\"location='/add/item?code=${decodedText}'\">Item</button>`
            + `<button class=\"btn btn-sm btn-primary me-2\" onclick=\"location='/add/container?code=${decodedText}'\">Container</button>`
            + `<button class=\"btn btn-sm btn-primary\" onclick=\"location='/add/location?code=${decodedText}'\">Location</button>`
            + `</div>`;
        }
      }
    })
    .finally(()=>{
      processNext();
    });
}

function handleScan(decodedText){
  const now = Date.now();
  for (const [code, time] of recentScans) {
    if (now - time > pollInterval) {
      recentScans.delete(code);
    }
  }
  const lastTime = recentScans.get(decodedText);
  if(lastTime && (now - lastTime) < pollInterval){
    return;
  }
  recentScans.set(decodedText, now);
  queue.push(decodedText);
  if(!processing){
    processing = true;
    processNext();
  }
}

doneBtn.addEventListener('click', ()=>{
  if(pendingTimeout){
    clearTimeout(pendingTimeout);
    pendingTimeout = null;
  }
  if(last){
    window.location = `/${last.type}/${last.code}`;
  }
});

let lastTick = 0;
function tick(){
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    const now = Date.now();
    if(now - lastTick > pollInterval){
      lastTick = now;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if(code){
        handleScan(code.data);
      }
    }
  }
  requestAnimationFrame(tick);
}

startBtn.addEventListener('click', initCameras);
</script>
{% endblock %}

