{% extends 'base.html' %}
{% block content %}
<h2>{{ item.name }}</h2>
{% if item.image %}
  <img src="{{ url_for('static', filename=item.image) }}" class="img-fluid mb-3 mx-auto d-block" style="max-width:200px;">
{% endif %}
<img src="{{ url_for('static', filename='qr/' + item.code + '.png') }}" class="mb-3 mx-auto d-block qr-img">
<a class="btn btn-primary mb-3 d-block mx-auto" download href="{{ url_for('static', filename='qr/' + item.code + '.png') }}">Download QR</a>
<table class="table table-sm mb-3">
  <tr><th>Code</th><td>{{ item.code }}</td></tr>
  <tr><th>Type</th><td>{{ item.type }}</td></tr>
  <tr><th>Quantity</th><td>{{ item.quantity }}</td></tr>
  <tr><th>Location</th><td>{{ item.location.full_path() if item.location else '' }}</td></tr>
  <tr><th>Container</th><td>{% if item.container %}{{ item.container.full_path() }}{% endif %}</td></tr>
  <tr><th>Created</th><td><span class="timestamp" data-ts="{{ item.created_at.isoformat() }}Z"></span> by {{ item.created_by.username if item.created_by else 'n/a' }}</td></tr>
  <tr><th>Updated</th><td><span class="timestamp" data-ts="{{ item.updated_at.isoformat() }}Z"></span> by {{ item.updated_by.username if item.updated_by else 'n/a' }}</td></tr>
  <tr><th>Missing</th><td>{{ 'Yes' if item.missing else 'No' }}</td></tr>
</table>
{% if custom_data %}
<h4>Custom Data</h4>
<table class="table table-sm mb-3">
  {% for k,v in custom_data.items() %}
  <tr><th>{{ k }}</th><td>{{ v }}</td></tr>
  {% endfor %}
</table>
{% endif %}
<div class="buttons-vertical">
  <a class="btn btn-primary" href="/item/{{ item.code }}/split">Split</a>
  <a class="btn btn-primary" href="/item/{{ item.code }}/join">Join</a>
  <a class="btn btn-primary" href="/relation/add/item/{{ item.code }}">Add Relation</a>
  <a class="btn btn-warning" href="/item/{{ item.code }}/remove">Remove from location</a>
  <a class="btn btn-info" href="/item/{{ item.code }}/edit">Edit</a>
  <a class="btn btn-danger" href="/item/{{ item.code }}/delete" onclick="return confirm('Delete item?');">Delete</a>
  {% if item.missing %}
  <form action="/item/{{ item.code }}/found" method="post">
    <button class="btn btn-success w-100">Report Found</button>
  </form>
  {% else %}
  <form action="/item/{{ item.code }}/missing" method="post">
    <button class="btn btn-danger w-100">Report Missing</button>
  </form>
  {% endif %}
  <button class="btn btn-primary w-100" type="button" id="scan-new-btn">Scan New QR</button>
  <div id="scan-area" style="display:none" class="mt-2">
    <select id="camera-select" class="form-select mb-2"></select>
    <video id="video" style="width:100%;max-width:400px;" autoplay muted playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="scan-msg" class="text-danger small mt-1"></div>
  </div>
  <form action="/item/{{ item.code }}/regen" method="post">
    <button class="btn btn-primary w-100">New QR Code</button>
  </form>
</div>

  <div class="accordion mt-3" id="logAcc">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingLog">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLog">Item Log</button>
    </h2>
    <div id="collapseLog" class="accordion-collapse collapse show">
      <div class="accordion-body p-0">
        <ul class="list-group list-group-flush">
          {% for h in item.histories|sort(attribute='timestamp', reverse=True) %}
            <li class="list-group-item"><span class="timestamp" data-ts="{{ h.timestamp.isoformat() }}Z"></span> - {{ h.action }}{% if h.location %} {{ h.location.full_path() }}{% elif h.container %} {{ h.container.full_path() }}{% endif %}{% if h.user %} by {{ h.user.username }}{% endif %}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% if related %}
<h4>Relations</h4>
<ul>
{% for r in related %}
  <li><a href="{{ r.url }}">{{ r.name }}</a></li>
{% endfor %}
</ul>
{% endif %}
<script src="{{ url_for('static', filename='js/jsqr.js') }}"></script>
<script>
const scanBtn=document.getElementById('scan-new-btn');
const scanArea=document.getElementById('scan-area');
const cameraSelect=document.getElementById('camera-select');
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
let stream=null;let pending=null;const msg=document.getElementById('scan-msg');
function beep(){const ctx=new (window.AudioContext||window.webkitAudioContext)();const osc=ctx.createOscillator();osc.frequency.value=440;osc.connect(ctx.destination);osc.start();setTimeout(()=>osc.stop(),150);}
async function startStream(id){if(stream){stream.getTracks().forEach(t=>t.stop());}const cons={video:id?{deviceId:{exact:id}}:{facingMode:{ideal:'environment'}},audio:false};stream=await navigator.mediaDevices.getUserMedia(cons);video.srcObject=stream;await video.play();requestAnimationFrame(tick);}
async function init(){const devices=await navigator.mediaDevices.enumerateDevices();const cams=devices.filter(d=>d.kind==='videoinput');cameraSelect.innerHTML='';cams.forEach((c,i)=>{const opt=document.createElement('option');opt.value=c.deviceId;opt.text=c.label||`Camera ${i+1}`;cameraSelect.appendChild(opt);});cameraSelect.style.display=cams.length>1?'block':'none';const pref=cams.find(c=>/back|rear|environment/i.test(c.label))||cams[0];cameraSelect.value=pref.deviceId;startStream(pref.deviceId);}
cameraSelect.addEventListener('change',()=>startStream(cameraSelect.value));
function stop(){if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}}
function send(code,confirm){fetch(`/item/{{ item.code }}/assign`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:code,confirm:confirm})}).then(r=>{if(r.status===409){pending=code;msg.textContent='Code in use. Scan again to confirm.';scanArea.style.display='block';startStream(cameraSelect.value);return;}if(r.ok){location.href='/item/'+code;}});}
function handleScan(code){beep();if(pending&&pending===code){send(code,true);stop();return;}pending=code;send(code,false);stop();}
function tick(){if(video.readyState===video.HAVE_ENOUGH_DATA){canvas.width=video.videoWidth;canvas.height=video.videoHeight;ctx.drawImage(video,0,0,canvas.width,canvas.height);const img=ctx.getImageData(0,0,canvas.width,canvas.height);const qr=jsQR(img.data,img.width,img.height);if(qr){handleScan(qr.data);return;}}requestAnimationFrame(tick);}
scanBtn.addEventListener('click',()=>{scanArea.style.display='block';msg.textContent='';init();});
</script>
{% endblock %}

